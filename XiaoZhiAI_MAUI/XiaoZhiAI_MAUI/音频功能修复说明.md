# 音频功能修复说明

## 修复的问题

### 1. 录音逻辑问题
**原问题**: Windows平台使用模拟录音，生成测试音调而不是真实的麦克风输入
**修复方案**: 
- 实现了真实的Windows WaveIn API录音功能
- 添加了麦克风权限和设备访问
- 正确处理16kHz采样率的录音数据

### 2. 音频播放混乱问题  
**原问题**: 播放时同时播放解码音频和测试音调，导致音频混乱
**修复方案**:
- 移除了播放时的测试音调生成
- 清理了不必要的`TestDirectAudioPlayback`方法
- 确保只播放从服务端接收的解码音频

### 3. 音频数据流程优化
**原问题**: 音频数据处理流程不清晰
**修复方案**: 明确了完整的音频处理流程

## 正确的音频流程

### 录音流程 (客户端 → 服务端)
```
1. 用户点击录音按钮
2. Windows WaveIn API 开始录制麦克风 (16kHz, 16位, 单声道)
3. 录音回调接收原始PCM数据
4. 转换为float数组并缓存
5. AudioService处理循环提取960采样帧 (60ms)
6. VAD (语音活动检测) 检测是否有语音
7. Opus编码器压缩音频数据
8. 通过WebSocket发送压缩后的二进制数据到服务端
```

### 播放流程 (服务端 → 客户端)  
```
1. 服务端处理语音并返回TTS音频数据
2. 客户端WebSocket接收二进制音频数据
3. Opus解码器解压音频数据为float数组 (24kHz)
4. 添加到播放队列
5. Windows WaveOut API播放音频 (24kHz, 16位, 单声道)
```

## 关键技术细节

### 音频格式
- **录音**: 16kHz, 16位, 单声道 (适合语音识别)
- **播放**: 24kHz, 16位, 单声道 (适合TTS播放)
- **帧大小**: 录音960采样(60ms), 播放1440采样(60ms)

### Opus编解码
- **录音编码**: 16kHz → Opus压缩 → 发送
- **播放解码**: 接收 → Opus解压 → 24kHz播放

### VAD (语音活动检测)
- 阈值: 0.02f
- 静音帧数: 30帧 (约0.5秒)
- TTS冷却时间: 1.5秒 (避免回音误触发)

## 使用方法

1. **启动应用**: 音频服务会自动初始化
2. **开始录音**: 点击录音按钮，开始真实麦克风录音
3. **语音检测**: VAD自动检测语音活动
4. **自动停止**: 检测到静音后自动停止录音并发送
5. **接收播放**: 自动接收服务端音频并播放

## 调试信息

应用会输出详细的调试日志，包括:
- 音频服务初始化状态
- 录音设备打开/关闭
- 音频数据处理 (采样数、编码状态)
- VAD检测结果
- 播放队列状态
- WebSocket通信状态

## 注意事项

1. **权限**: 确保应用有麦克风访问权限
2. **设备**: 确保系统有可用的录音和播放设备
3. **网络**: 确保WebSocket连接正常
4. **Opus库**: 确保平台特定的Opus原生库正确加载

## 测试建议

1. 检查录音是否能正确捕获麦克风输入
2. 验证Opus编码是否正常工作
3. 测试WebSocket二进制数据传输
4. 确认服务端返回的音频能正确播放
5. 验证VAD是否能正确检测语音开始/结束 