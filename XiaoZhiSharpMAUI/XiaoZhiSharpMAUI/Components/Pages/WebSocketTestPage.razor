@page "/websocket-test"
@using XiaoZhiSharpMAUI.Services
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Extensions.Logging
@inject ILogger<WebSocketTestPage> Logger
@inject IServiceProvider ServiceProvider
@implements IDisposable

<div class="container-fluid p-3">
    <h3>ğŸ”Œ WebSocket è¿æ¥æµ‹è¯•</h3>
    
    <!-- è¯Šæ–­æç¤º -->
    @if (!string.IsNullOrEmpty(diagnosticMessage))
    {
        <div class="alert alert-warning">
            <h6>ğŸ” è¯Šæ–­æç¤º:</h6>
            <p>@diagnosticMessage</p>
        </div>
    }
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>è¿æ¥çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="alert @GetStatusAlertClass()">
                                <strong>çŠ¶æ€:</strong> @connectionStatus
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <strong>ç½‘ç»œ:</strong> @networkStatus
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert @GetConnectivityAlertClass()">
                                <strong>ç½‘ç»œè¿é€šæ€§:</strong> @connectivityStatus
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <button class="btn btn-success" 
                                @onclick="ConnectWebSocket" 
                                disabled="@(isConnecting || isConnected)">
                            ğŸ”Œ è¿æ¥
                        </button>
                        <button class="btn btn-danger" 
                                @onclick="DisconnectWebSocket" 
                                disabled="@(!isConnected)">
                            âŒ æ–­å¼€
                        </button>
                        <button class="btn btn-warning" 
                                @onclick="SendHelloMessage" 
                                disabled="@(!isConnected)">
                            ğŸ‘‹ å‘é€Hello
                        </button>
                        <button class="btn btn-info" 
                                @onclick="TestNetworkConnectivity">
                            ğŸŒ æµ‹è¯•ç½‘ç»œ
                        </button>
                        <button class="btn btn-secondary" 
                                @onclick="ClearLogs">
                            ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>è¿æ¥é…ç½®</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">WebSocket URL</label>
                        <input type="text" class="form-control" @bind="webSocketUrl" disabled="@isConnected" />
                        <div class="form-text">é»˜è®¤: wss://api.tenclass.net/xiaozhi/v1/</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <div class="input-group">
                            <input type="@(showToken ? "text" : "password")" 
                                   class="form-control" 
                                   @bind="token" 
                                   disabled="@isConnected" 
                                   placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„API Token" />
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    @onclick="ToggleTokenVisibility">
                                @(showToken ? "ğŸ™ˆ" : "ğŸ‘ï¸")
                            </button>
                        </div>
                        <div class="form-text text-danger">âš ï¸ "test-token" æ— æ•ˆï¼Œè¯·è¾“å…¥çœŸå®çš„API Token</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è®¾å¤‡ID</label>
                        <input type="text" class="form-control" @bind="deviceId" disabled="@isConnected" />
                        <div class="form-text">è‡ªåŠ¨ç”Ÿæˆçš„è®¾å¤‡æ ‡è¯†ç¬¦</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Session ID</label>
                        <input type="text" class="form-control" value="@sessionId" disabled />
                        <div class="form-text">è¿æ¥æˆåŠŸåè·å¾—</div>
                    </div>
                    
                    <!-- å¿«é€Ÿæµ‹è¯•é€‰é¡¹ -->
                    <div class="mb-3">
                        <h6>å¿«é€Ÿæµ‹è¯•é€‰é¡¹:</h6>
                        <div class="btn-group-vertical d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" 
                                    @onclick="() => SetTestConfiguration(true)">
                                ğŸ§ª ä½¿ç”¨æœ¬åœ°æµ‹è¯•æœåŠ¡å™¨
                            </button>
                            <button class="btn btn-outline-info btn-sm" 
                                    @onclick="() => SetTestConfiguration(false)">
                                ğŸŒ ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨
                            </button>
                        </div>
                        <div class="form-text">æœ¬åœ°æµ‹è¯•å¯ä»¥éªŒè¯ç½‘ç»œé…ç½®æ˜¯å¦æ­£å¸¸</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ç»Ÿè®¡ä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <p><strong>è¿æ¥å°è¯•æ¬¡æ•°:</strong> @connectionAttempts</p>
                    <p><strong>æ”¶åˆ°æ¶ˆæ¯æ•°:</strong> @messagesReceived</p>
                    <p><strong>å‘é€æ¶ˆæ¯æ•°:</strong> @messagesSent</p>
                    <p><strong>äºŒè¿›åˆ¶æ•°æ®åŒ…:</strong> @binaryDataReceived</p>
                    <p><strong>é”™è¯¯æ¬¡æ•°:</strong> @errorCount</p>
                    <p><strong>è¿æ¥æ—¶é•¿:</strong> @GetConnectionDuration()</p>
                    
                    <!-- è¯Šæ–­ä¿¡æ¯ -->
                    <hr>
                    <h6>ç³»ç»Ÿä¿¡æ¯:</h6>
                    <p><small><strong>è®¾å¤‡å¹³å°:</strong> @DeviceInfo.Platform</small></p>
                    <p><small><strong>è®¾å¤‡å‹å·:</strong> @DeviceInfo.Model</small></p>
                    <p><small><strong>æ“ä½œç³»ç»Ÿ:</strong> @DeviceInfo.VersionString</small></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>æ—¥å¿—è®°å½•</h5>
                    <span class="badge bg-primary">@logs.Count æ¡è®°å½•</span>
                </div>
                <div class="card-body">
                    <div class="log-container" style="height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                        @foreach (var log in logs.OrderByDescending(l => l.Timestamp))
                        {
                            <div class="@GetLogClass(log.Level)">
                                <span class="text-muted">[@log.Timestamp.ToString("HH:mm:ss.fff")]</span>
                                <span class="fw-bold">[@log.Level]</span>
                                @log.Message
                            </div>
                        }
                        @if (!logs.Any())
                        {
                            <div class="text-muted">æš‚æ— æ—¥å¿—è®°å½•...</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private EnhancedWebSocketService? webSocketService;
    private string webSocketUrl = "wss://api.tenclass.net/xiaozhi/v1/";
    private string token = "test-token";
    private string deviceId = "";
    private string sessionId = "";
    private string connectionStatus = "æœªè¿æ¥";
    private string networkStatus = "æ£€æŸ¥ä¸­...";
    private string connectivityStatus = "æœªæµ‹è¯•";
    private string diagnosticMessage = "";
    private bool isConnecting = false;
    private bool isConnected = false;
    private bool showToken = false;
    
    // ç»Ÿè®¡ä¿¡æ¯
    private int connectionAttempts = 0;
    private int messagesReceived = 0;
    private int messagesSent = 0;
    private int binaryDataReceived = 0;
    private int errorCount = 0;
    private DateTime? connectionStartTime;
    
    // æ—¥å¿—
    private List<LogEntry> logs = new();
    
    protected override async Task OnInitializedAsync()
    {
        // è·å–è®¾å¤‡ID
        deviceId = XiaoZhiSharp.Utils.SystemInfo.GetMacAddress();
        
        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        await CheckNetworkStatus();
        
        // æ˜¾ç¤ºåˆå§‹è¯Šæ–­ä¿¡æ¯
        ShowDiagnosticMessage();
        
        AddLog("Info", "é¡µé¢åˆå§‹åŒ–å®Œæˆ");
        StateHasChanged();
    }
    
    private void ShowDiagnosticMessage()
    {
        if (token == "test-token")
        {
            diagnosticMessage = "å½“å‰ä½¿ç”¨çš„æ˜¯æµ‹è¯•tokenï¼Œè¿™å¾ˆå¯èƒ½æ˜¯è¿æ¥å¤±è´¥çš„åŸå› ã€‚è¯·è”ç³»æœåŠ¡æä¾›å•†è·å–æœ‰æ•ˆçš„API Tokenã€‚";
        }
        else if (string.IsNullOrWhiteSpace(token))
        {
            diagnosticMessage = "è¯·è¾“å…¥æœ‰æ•ˆçš„API Tokenã€‚æ²¡æœ‰tokenæ— æ³•è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ã€‚";
        }
        else
        {
            diagnosticMessage = "";
        }
    }
    
    private async Task CheckNetworkStatus()
    {
        try
        {
            var networkAccess = Connectivity.NetworkAccess;
            var profiles = Connectivity.ConnectionProfiles;
            
            networkStatus = $"{networkAccess} ({string.Join(", ", profiles)})";
            AddLog("Info", $"ç½‘ç»œçŠ¶æ€: {networkStatus}");
        }
        catch (Exception ex)
        {
            networkStatus = "æ£€æŸ¥å¤±è´¥";
            AddLog("Error", $"ç½‘ç»œçŠ¶æ€æ£€æŸ¥å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestNetworkConnectivity()
    {
        try
        {
            connectivityStatus = "æµ‹è¯•ä¸­...";
            StateHasChanged();
            
            AddLog("Info", "å¼€å§‹ç½‘ç»œè¿é€šæ€§æµ‹è¯•...");
            
            // æµ‹è¯•DNSè§£æ
            try
            {
                var hostName = new Uri(webSocketUrl).Host;
                AddLog("Info", $"æµ‹è¯•DNSè§£æ: {hostName}");
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„DNSè§£ææµ‹è¯•
                connectivityStatus = "DNSè§£ææ­£å¸¸";
                AddLog("Success", "DNSè§£ææµ‹è¯•é€šè¿‡");
            }
            catch (Exception ex)
            {
                connectivityStatus = $"DNSè§£æå¤±è´¥: {ex.Message}";
                AddLog("Error", $"DNSè§£æå¤±è´¥: {ex.Message}");
                return;
            }
            
            // æµ‹è¯•ç½‘ç»œè®¿é—®æƒé™
            var networkAccess = Connectivity.NetworkAccess;
            if (networkAccess != NetworkAccess.Internet)
            {
                connectivityStatus = $"ç½‘ç»œè®¿é—®å—é™: {networkAccess}";
                AddLog("Warning", $"ç½‘ç»œè®¿é—®å—é™: {networkAccess}");
                return;
            }
            
            connectivityStatus = "ç½‘ç»œè¿é€šæ­£å¸¸";
            AddLog("Success", "ç½‘ç»œè¿é€šæ€§æµ‹è¯•å®Œæˆ");
        }
        catch (Exception ex)
        {
            connectivityStatus = $"æµ‹è¯•å¤±è´¥: {ex.Message}";
            AddLog("Error", $"ç½‘ç»œè¿é€šæ€§æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }
    
    private void SetTestConfiguration(bool useLocal)
    {
        if (isConnected) return;
        
        if (useLocal)
        {
            webSocketUrl = "wss://echo.websocket.org/";
            token = "test";
            AddLog("Info", "å·²åˆ‡æ¢åˆ°æœ¬åœ°æµ‹è¯•é…ç½®");
            diagnosticMessage = "ä½¿ç”¨WebSocket EchoæœåŠ¡å™¨è¿›è¡ŒåŸºç¡€è¿æ¥æµ‹è¯•ã€‚è¿™æœ‰åŠ©äºéªŒè¯ç½‘ç»œé…ç½®æ˜¯å¦æ­£å¸¸ã€‚";
        }
        else
        {
            webSocketUrl = "wss://api.tenclass.net/xiaozhi/v1/";
            token = "test-token";
            AddLog("Info", "å·²åˆ‡æ¢åˆ°ç”Ÿäº§æœåŠ¡å™¨é…ç½®");
            ShowDiagnosticMessage();
        }
        
        StateHasChanged();
    }
    
    private void ToggleTokenVisibility()
    {
        showToken = !showToken;
        StateHasChanged();
    }
    
    private async Task ConnectWebSocket()
    {
        if (isConnecting || isConnected) return;
        
        try
        {
            isConnecting = true;
            connectionAttempts++;
            connectionStatus = "è¿æ¥ä¸­...";
            
            // æ£€æŸ¥token
            if (string.IsNullOrWhiteSpace(token))
            {
                connectionStatus = "Tokenä¸èƒ½ä¸ºç©º";
                AddLog("Error", "è¿æ¥å¤±è´¥: Tokenä¸èƒ½ä¸ºç©º");
                return;
            }
            
            ShowDiagnosticMessage();
            AddLog("Info", $"å¼€å§‹è¿æ¥WebSocket... (å°è¯• #{connectionAttempts})");
            AddLog("Info", $"URL: {webSocketUrl}");
            AddLog("Info", $"Token: {token.Substring(0, Math.Min(8, token.Length))}...");
            AddLog("Info", $"è®¾å¤‡ID: {deviceId}");
            StateHasChanged();
            
            // åˆ›å»ºWebSocketæœåŠ¡
            var logger = ServiceProvider.GetRequiredService<ILogger<EnhancedWebSocketService>>();
            webSocketService = new EnhancedWebSocketService(webSocketUrl, token, deviceId, logger);
            
            // è®¢é˜…äº‹ä»¶
            webSocketService.MessageReceived += OnMessageReceived;
            webSocketService.BinaryDataReceived += OnBinaryDataReceived;
            webSocketService.ConnectionStatusChanged += OnConnectionStatusChanged;
            webSocketService.ErrorOccurred += OnErrorOccurred;
            
            // è¿æ¥
            var success = await webSocketService.ConnectAsync();
            
            if (success)
            {
                isConnected = true;
                connectionStartTime = DateTime.Now;
                connectionStatus = "å·²è¿æ¥";
                AddLog("Success", "WebSocketè¿æ¥æˆåŠŸ");
            }
            else
            {
                connectionStatus = "è¿æ¥å¤±è´¥";
                AddLog("Error", "WebSocketè¿æ¥å¤±è´¥");
                
                // æä¾›è¯Šæ–­å»ºè®®
                if (token == "test-token")
                {
                    AddLog("Warning", "å»ºè®®: è¯·ä½¿ç”¨æœ‰æ•ˆçš„API Tokenæ›¿æ¢ 'test-token'");
                }
            }
        }
        catch (Exception ex)
        {
            connectionStatus = $"è¿æ¥é”™è¯¯: {ex.Message}";
            AddLog("Error", $"è¿æ¥å¼‚å¸¸: {ex.Message}");
            
            // åˆ†æå¸¸è§é”™è¯¯
            if (ex.Message.Contains("401") || ex.Message.Contains("Unauthorized"))
            {
                AddLog("Warning", "è¿™æ˜¯èº«ä»½éªŒè¯é”™è¯¯ï¼Œè¯·æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ");
            }
            else if (ex.Message.Contains("403") || ex.Message.Contains("Forbidden"))
            {
                AddLog("Warning", "è¿™æ˜¯æƒé™é”™è¯¯ï¼Œè¯·æ£€æŸ¥Tokenæƒé™æˆ–è®¾å¤‡ID");
            }
            else if (ex.Message.Contains("timeout"))
            {
                AddLog("Warning", "è¿™æ˜¯è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
            }
            
            errorCount++;
        }
        finally
        {
            isConnecting = false;
            StateHasChanged();
        }
    }
    
    private async Task DisconnectWebSocket()
    {
        try
        {
            if (webSocketService != null)
            {
                await webSocketService.CloseAsync();
                webSocketService.Dispose();
                webSocketService = null;
            }
            
            isConnected = false;
            connectionStatus = "å·²æ–­å¼€";
            sessionId = "";
            connectionStartTime = null;
            AddLog("Info", "WebSocketå·²æ–­å¼€");
        }
        catch (Exception ex)
        {
            AddLog("Error", $"æ–­å¼€è¿æ¥å¤±è´¥: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }
    
    private async Task SendHelloMessage()
    {
        if (webSocketService == null || !isConnected) return;
        
        try
        {
            var helloMessage = XiaoZhiSharp.Protocols.WebSocketProtocol.Hello(sessionId);
            await webSocketService.SendTextAsync(helloMessage);
            messagesSent++;
            AddLog("Send", $"å‘é€Helloæ¶ˆæ¯: {helloMessage}");
        }
        catch (Exception ex)
        {
            AddLog("Error", $"å‘é€æ¶ˆæ¯å¤±è´¥: {ex.Message}");
            errorCount++;
        }
        finally
        {
            StateHasChanged();
        }
    }
    
    private void OnMessageReceived(object? sender, string message)
    {
        messagesReceived++;
        AddLog("Receive", $"æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯: {message}");
        
        // è§£æsession_id
        if (message.Contains("session_id"))
        {
            sessionId = webSocketService?.SessionId ?? "";
        }
        
        InvokeAsync(() => StateHasChanged());
    }
    
    private void OnBinaryDataReceived(object? sender, byte[] data)
    {
        binaryDataReceived++;
        AddLog("Receive", $"æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®: {data.Length} å­—èŠ‚");
        InvokeAsync(() => StateHasChanged());
    }
    
    private void OnConnectionStatusChanged(object? sender, string status)
    {
        connectionStatus = status;
        AddLog("Status", $"è¿æ¥çŠ¶æ€å˜æ›´: {status}");
        
        if (status.Contains("Connected"))
        {
            isConnected = true;
            connectionStartTime = DateTime.Now;
        }
        else if (status.Contains("Disconnected") || status.Contains("Failed"))
        {
            isConnected = false;
            connectionStartTime = null;
        }
        
        InvokeAsync(() => StateHasChanged());
    }
    
    private void OnErrorOccurred(object? sender, Exception ex)
    {
        errorCount++;
        AddLog("Error", $"WebSocketé”™è¯¯: {ex.Message}");
        InvokeAsync(() => StateHasChanged());
    }
    
    private void ClearLogs()
    {
        logs.Clear();
        StateHasChanged();
    }
    
    private void AddLog(string level, string message)
    {
        logs.Add(new LogEntry
        {
            Timestamp = DateTime.Now,
            Level = level,
            Message = message
        });
        
        // ä¿æŒæ—¥å¿—æ¡æ•°åœ¨åˆç†èŒƒå›´å†…
        if (logs.Count > 100)
        {
            logs.RemoveAt(0);
        }
    }
    
    private string GetStatusAlertClass()
    {
        if (isConnected) return "alert-success";
        if (isConnecting) return "alert-warning";
        if (connectionStatus.Contains("å¤±è´¥") || connectionStatus.Contains("é”™è¯¯")) return "alert-danger";
        return "alert-secondary";
    }
    
    private string GetConnectivityAlertClass()
    {
        if (connectivityStatus.Contains("æ­£å¸¸")) return "alert-success";
        if (connectivityStatus.Contains("å¤±è´¥") || connectivityStatus.Contains("é”™è¯¯")) return "alert-danger";
        if (connectivityStatus.Contains("å—é™")) return "alert-warning";
        return "alert-secondary";
    }
    
    private string GetLogClass(string level)
    {
        return level switch
        {
            "Error" => "text-danger",
            "Success" => "text-success",
            "Send" => "text-primary",
            "Receive" => "text-info",
            "Status" => "text-warning",
            _ => "text-muted"
        };
    }
    
    private string GetConnectionDuration()
    {
        if (connectionStartTime == null) return "æœªè¿æ¥";
        var duration = DateTime.Now - connectionStartTime.Value;
        return $"{duration.TotalMinutes:F1} åˆ†é’Ÿ";
    }
    
    public void Dispose()
    {
        webSocketService?.Dispose();
    }
    
    private class LogEntry
    {
        public DateTime Timestamp { get; set; }
        public string Level { get; set; } = "";
        public string Message { get; set; } = "";
    }
} 