@page "/audio-test"
@using XiaoZhiSharpMAUI.Services
@using Microsoft.Maui.ApplicationModel
@inject IMauiAudioService AudioService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="container-fluid p-3">
    <h3>ğŸµ MAUIéŸ³é¢‘æœåŠ¡æµ‹è¯•</h3>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ™ï¸ å½•éŸ³åŠŸèƒ½</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-success" 
                                @onclick="StartRecording" 
                                disabled="@(AudioService.IsRecording)">
                            ğŸ™ï¸ å¼€å§‹å½•éŸ³
                        </button>
                        <button class="btn btn-danger" 
                                @onclick="StopRecording" 
                                disabled="@(!AudioService.IsRecording)">
                            â¹ï¸ åœæ­¢å½•éŸ³
                        </button>
                    </div>
                    
                    <div class="alert @(AudioService.IsRecording ? "alert-success" : "alert-secondary")">
                        çŠ¶æ€: @(AudioService.IsRecording ? "æ­£åœ¨å½•éŸ³..." : "æœªå½•éŸ³")
                    </div>
                    
                    @if (!string.IsNullOrEmpty(recordingMessage))
                    {
                        <div class="alert alert-info">
                            @recordingMessage
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ”Š æ’­æ”¾åŠŸèƒ½</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary" 
                                @onclick="PlayTestSound" 
                                disabled="@(AudioService.IsPlaying)">
                            ğŸ”Š æ’­æ”¾æµ‹è¯•éŸ³é¢‘
                        </button>
                        <button class="btn btn-warning" 
                                @onclick="StopPlaying" 
                                disabled="@(!AudioService.IsPlaying)">
                            â¸ï¸ åœæ­¢æ’­æ”¾
                        </button>
                    </div>
                    
                    <div class="alert @(AudioService.IsPlaying ? "alert-primary" : "alert-secondary")">
                        çŠ¶æ€: @(AudioService.IsPlaying ? "æ­£åœ¨æ’­æ”¾..." : "æœªæ’­æ”¾")
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">éŸ³é‡æ§åˆ¶</label>
                        <input type="range" 
                               class="form-range" 
                               min="0" 
                               max="100" 
                               @bind="volume" 
                               @oninput="OnVolumeChanged" />
                        <small class="text-muted">å½“å‰éŸ³é‡: @volume%</small>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(playbackMessage))
                    {
                        <div class="alert alert-info">
                            @playbackMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š éŸ³é¢‘æ•°æ®ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <p><strong>å½•éŸ³æ•°æ®åŒ…æ•°é‡:</strong> @recordedPacketCount</p>
                    <p><strong>æ€»å½•éŸ³æ—¶é•¿:</strong> @totalRecordingTime ç§’</p>
                    <p><strong>æœ€åæ›´æ–°:</strong> @lastUpdateTime</p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string recordingMessage = "";
    private string playbackMessage = "";
    private int volume = 50;
    private int recordedPacketCount = 0;
    private double totalRecordingTime = 0;
    private string lastUpdateTime = "";
    private DateTime recordingStartTime;

    protected override void OnInitialized()
    {
        // è®¢é˜…å½•éŸ³æ•°æ®äº‹ä»¶
        AudioService.RecordDataAvailable += OnRecordDataAvailable;
        base.OnInitialized();
    }

    private async Task StartRecording()
    {
        try
        {
            recordingMessage = "æ­£åœ¨å¯åŠ¨å½•éŸ³...";
            StateHasChanged();
            
            recordingStartTime = DateTime.Now;
            recordedPacketCount = 0;
            
            await AudioService.StartRecordingAsync();
            recordingMessage = "å½•éŸ³å·²å¼€å§‹ï¼";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            recordingMessage = $"å½•éŸ³å¯åŠ¨å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task StopRecording()
    {
        try
        {
            await AudioService.StopRecordingAsync();
            totalRecordingTime = (DateTime.Now - recordingStartTime).TotalSeconds;
            recordingMessage = $"å½•éŸ³å·²åœæ­¢ï¼Œå…±å½•åˆ¶ {totalRecordingTime:F1} ç§’";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            recordingMessage = $"åœæ­¢å½•éŸ³å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task PlayTestSound()
    {
        try
        {
            playbackMessage = "æ­£åœ¨å‡†å¤‡æ’­æ”¾æµ‹è¯•éŸ³é¢‘...";
            StateHasChanged();

            // ç”Ÿæˆä¸€ä¸ªç®€å•çš„æµ‹è¯•éŸ³é¢‘ (æ­£å¼¦æ³¢)
            var testAudio = GenerateTestAudio();
            
            await AudioService.PlayAudioAsync(testAudio);
            playbackMessage = "æµ‹è¯•éŸ³é¢‘æ’­æ”¾ä¸­...";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            playbackMessage = $"æ’­æ”¾å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task StopPlaying()
    {
        try
        {
            await AudioService.StopPlayingAsync();
            playbackMessage = "æ’­æ”¾å·²åœæ­¢";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            playbackMessage = $"åœæ­¢æ’­æ”¾å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }

    private void OnVolumeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newVolume))
        {
            volume = newVolume;
            AudioService.SetVolume(volume / 100.0);
        }
    }

    private void OnRecordDataAvailable(object? sender, byte[] audioData)
    {
        recordedPacketCount++;
        lastUpdateTime = DateTime.Now.ToString("HH:mm:ss.fff");
        
        // åœ¨UIçº¿ç¨‹ä¸­æ›´æ–°çŠ¶æ€
        InvokeAsync(() => StateHasChanged());
    }

    private byte[] GenerateTestAudio()
    {
        // ç”Ÿæˆ1ç§’çš„440Hzæ­£å¼¦æ³¢ (AéŸ³ç¬¦)
        const int sampleRate = 44100;
        const int duration = 1; // ç§’
        const double frequency = 440.0; // Hz
        
        var samples = new short[sampleRate * duration];
        for (int i = 0; i < samples.Length; i++)
        {
            double time = i / (double)sampleRate;
            double amplitude = Math.Sin(2 * Math.PI * frequency * time);
            samples[i] = (short)(amplitude * short.MaxValue * 0.3); // 30%éŸ³é‡é¿å…è¿‡å“
        }
        
        // è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
        var bytes = new byte[samples.Length * 2];
        for (int i = 0; i < samples.Length; i++)
        {
            var sampleBytes = BitConverter.GetBytes(samples[i]);
            bytes[i * 2] = sampleBytes[0];
            bytes[i * 2 + 1] = sampleBytes[1];
        }
        
        return bytes;
    }

    public void Dispose()
    {
        AudioService.RecordDataAvailable -= OnRecordDataAvailable;
    }
} 