@page "/android-network-diagnostic"
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Networking
@using Microsoft.Extensions.Logging
@using System.Net.NetworkInformation
@using System.Net.Http
@using System.Net.WebSockets
@inject ILogger<AndroidNetworkDiagnosticPage> Logger
@implements IDisposable

<div class="container-fluid p-3">
    <h3>ğŸ“± Android ç½‘ç»œè¯Šæ–­å·¥å…·</h3>
    
    <div class="alert alert-info">
        <h6>ğŸ” è¯Šæ–­ç›®æ ‡:</h6>
        <p>æ£€æµ‹Androidè®¾å¤‡ä¸Šçš„ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œç¡®å®šWebSocketè¿æ¥å¤±è´¥çš„æ ¹æœ¬åŸå› ã€‚</p>
    </div>
    
    <!-- æ€»ä½“çŠ¶æ€ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š æ€»ä½“è¯Šæ–­çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar @GetProgressClass()" 
                             role="progressbar" 
                             style="width: @(testProgress)%" 
                             aria-valuenow="@testProgress" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @testProgress%
                        </div>
                    </div>
                    <p><strong>å½“å‰æµ‹è¯•:</strong> @currentTest</p>
                    <p><strong>æ€»ä½“çŠ¶æ€:</strong> <span class="@GetOverallStatusClass()">@overallStatus</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary" 
                        @onclick="RunFullDiagnostic" 
                        disabled="@isRunning">
                    ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­
                </button>
                <button class="btn btn-warning" 
                        @onclick="RunBasicTests" 
                        disabled="@isRunning">
                    âš¡ å¿«é€Ÿæµ‹è¯•
                </button>
                <button class="btn btn-info" 
                        @onclick="TestWebSocketOnly" 
                        disabled="@isRunning">
                    ğŸ”Œ ä»…æµ‹è¯•WebSocket
                </button>
                <button class="btn btn-secondary" 
                        @onclick="ClearResults">
                    ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
                </button>
            </div>
        </div>
    </div>
    
    <!-- æµ‹è¯•ç»“æœ -->
    <div class="row">
        <!-- æƒé™æµ‹è¯• -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6>ğŸ›¡ï¸ æƒé™æ£€æŸ¥ @GetTestIcon(permissionStatus)</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>ç½‘ç»œæƒé™:</strong> 
                        <span class="@GetStatusClass(networkPermissionStatus)">@networkPermissionStatus</span>
                    </div>
                    <div class="mb-2">
                        <strong>WiFiæƒé™:</strong> 
                        <span class="@GetStatusClass(wifiPermissionStatus)">@wifiPermissionStatus</span>
                    </div>
                    <div class="mb-2">
                        <strong>ç½‘ç»œçŠ¶æ€æƒé™:</strong> 
                        <span class="@GetStatusClass(networkStatePermissionStatus)">@networkStatePermissionStatus</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç½‘ç»œçŠ¶æ€ -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6>ğŸŒ ç½‘ç»œçŠ¶æ€ @GetTestIcon(connectivityStatus)</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>ç½‘ç»œè®¿é—®:</strong> 
                        <span class="@GetStatusClass(networkAccess)">@networkAccess</span>
                    </div>
                    <div class="mb-2">
                        <strong>è¿æ¥é…ç½®:</strong> 
                        <span class="@GetStatusClass(connectionProfiles)">@connectionProfiles</span>
                    </div>
                    <div class="mb-2">
                        <strong>ç½‘ç»œæ¥å£:</strong> 
                        <span class="@GetStatusClass(networkInterfaces)">@networkInterfaces</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DNSè§£æ -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6>ğŸ”— DNSè§£æ @GetTestIcon(dnsStatus)</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>api.tenclass.net:</strong> 
                        <span class="@GetStatusClass(dnsTestResult)">@dnsTestResult</span>
                    </div>
                    <div class="mb-2">
                        <strong>google.com:</strong> 
                        <span class="@GetStatusClass(dnsGoogleResult)">@dnsGoogleResult</span>
                    </div>
                    <div class="mb-2">
                        <strong>è§£ææ—¶é—´:</strong> @dnsResolveTime
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HTTPè¿æ¥ -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6>ğŸŒ HTTPè¿æ¥ @GetTestIcon(httpStatus)</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>HTTPS Google:</strong> 
                        <span class="@GetStatusClass(httpGoogleResult)">@httpGoogleResult</span>
                    </div>
                    <div class="mb-2">
                        <strong>HTTPS APIæœåŠ¡å™¨:</strong> 
                        <span class="@GetStatusClass(httpApiResult)">@httpApiResult</span>
                    </div>
                    <div class="mb-2">
                        <strong>å“åº”æ—¶é—´:</strong> @httpResponseTime
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WebSocketè¿æ¥ -->
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6>ğŸ”Œ WebSocketè¿æ¥ @GetTestIcon(webSocketStatus)</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Echoæµ‹è¯•:</strong> 
                                <span class="@GetStatusClass(webSocketEchoResult)">@webSocketEchoResult</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>APIè¿æ¥:</strong> 
                                <span class="@GetStatusClass(webSocketApiResult)">@webSocketApiResult</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>è¿æ¥æ—¶é—´:</strong> @webSocketConnectTime
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>è¯¦ç»†é”™è¯¯:</strong> <small class="text-muted">@webSocketError</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¯¦ç»†æ—¥å¿— -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>ğŸ“ è¯¦ç»†æ—¥å¿—</h6>
                    <span class="badge bg-primary">@diagnosticLogs.Count æ¡è®°å½•</span>
                </div>
                <div class="card-body">
                    <div class="log-container" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; font-family: monospace; font-size: 11px;">
                        @foreach (var log in diagnosticLogs.OrderByDescending(l => l.Timestamp))
                        {
                            <div class="@GetLogClass(log.Level)">
                                <span class="text-muted">[@log.Timestamp.ToString("HH:mm:ss.fff")]</span>
                                <span class="fw-bold">[@log.Level]</span>
                                @log.Message
                            </div>
                        }
                        @if (!diagnosticLogs.Any())
                        {
                            <div class="text-muted">ç‚¹å‡»å¼€å§‹è¯Šæ–­...</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // æµ‹è¯•çŠ¶æ€
    private bool isRunning = false;
    private int testProgress = 0;
    private string currentTest = "ç­‰å¾…å¼€å§‹";
    private string overallStatus = "æœªå¼€å§‹";
    
    // æƒé™æµ‹è¯•ç»“æœ
    private string permissionStatus = "æœªæµ‹è¯•";
    private string networkPermissionStatus = "æœªæµ‹è¯•";
    private string wifiPermissionStatus = "æœªæµ‹è¯•";
    private string networkStatePermissionStatus = "æœªæµ‹è¯•";
    
    // ç½‘ç»œçŠ¶æ€ç»“æœ
    private string connectivityStatus = "æœªæµ‹è¯•";
    private string networkAccess = "æœªæµ‹è¯•";
    private string connectionProfiles = "æœªæµ‹è¯•";
    private string networkInterfaces = "æœªæµ‹è¯•";
    
    // DNSæµ‹è¯•ç»“æœ
    private string dnsStatus = "æœªæµ‹è¯•";
    private string dnsTestResult = "æœªæµ‹è¯•";
    private string dnsGoogleResult = "æœªæµ‹è¯•";
    private string dnsResolveTime = "æœªæµ‹è¯•";
    
    // HTTPæµ‹è¯•ç»“æœ
    private string httpStatus = "æœªæµ‹è¯•";
    private string httpGoogleResult = "æœªæµ‹è¯•";
    private string httpApiResult = "æœªæµ‹è¯•";
    private string httpResponseTime = "æœªæµ‹è¯•";
    
    // WebSocketæµ‹è¯•ç»“æœ
    private string webSocketStatus = "æœªæµ‹è¯•";
    private string webSocketEchoResult = "æœªæµ‹è¯•";
    private string webSocketApiResult = "æœªæµ‹è¯•";
    private string webSocketConnectTime = "æœªæµ‹è¯•";
    private string webSocketError = "";
    
    // æ—¥å¿—
    private List<LogEntry> diagnosticLogs = new();
    private readonly HttpClient httpClient = new();
    
    protected override void OnInitialized()
    {
        AddLog("Info", "Androidç½‘ç»œè¯Šæ–­å·¥å…·å·²åŠ è½½");
        AddLog("Info", $"è®¾å¤‡å¹³å°: {DeviceInfo.Platform}");
        AddLog("Info", $"è®¾å¤‡å‹å·: {DeviceInfo.Model}");
        AddLog("Info", $"æ“ä½œç³»ç»Ÿ: {DeviceInfo.VersionString}");
    }
    
    private async Task RunFullDiagnostic()
    {
        if (isRunning) return;
        
        try
        {
            isRunning = true;
            testProgress = 0;
            overallStatus = "è¯Šæ–­ä¸­...";
            ClearResults();
            
            AddLog("Info", "=== å¼€å§‹å®Œæ•´ç½‘ç»œè¯Šæ–­ ===");
            
            // 1. æƒé™æ£€æŸ¥ (20%)
            await TestPermissions();
            testProgress = 20;
            StateHasChanged();
            
            // 2. ç½‘ç»œçŠ¶æ€æ£€æŸ¥ (40%)
            await TestNetworkConnectivity();
            testProgress = 40;
            StateHasChanged();
            
            // 3. DNSè§£ææµ‹è¯• (60%)
            await TestDNSResolution();
            testProgress = 60;
            StateHasChanged();
            
            // 4. HTTPè¿æ¥æµ‹è¯• (80%)
            await TestHttpConnections();
            testProgress = 80;
            StateHasChanged();
            
            // 5. WebSocketè¿æ¥æµ‹è¯• (100%)
            await TestWebSocketConnections();
            testProgress = 100;
            StateHasChanged();
            
            // åˆ†æç»“æœ
            AnalyzeResults();
            
            AddLog("Success", "=== å®Œæ•´è¯Šæ–­å®Œæˆ ===");
        }
        catch (Exception ex)
        {
            AddLog("Error", $"è¯Šæ–­è¿‡ç¨‹å‡ºé”™: {ex.Message}");
            overallStatus = "è¯Šæ–­å¤±è´¥";
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }
    
    private async Task RunBasicTests()
    {
        if (isRunning) return;
        
        try
        {
            isRunning = true;
            testProgress = 0;
            overallStatus = "å¿«é€Ÿæµ‹è¯•ä¸­...";
            
            AddLog("Info", "=== å¼€å§‹å¿«é€Ÿç½‘ç»œæµ‹è¯• ===");
            
            await TestPermissions();
            testProgress = 50;
            StateHasChanged();
            
            await TestNetworkConnectivity();
            testProgress = 100;
            StateHasChanged();
            
            AddLog("Success", "=== å¿«é€Ÿæµ‹è¯•å®Œæˆ ===");
            overallStatus = "å¿«é€Ÿæµ‹è¯•å®Œæˆ";
        }
        catch (Exception ex)
        {
            AddLog("Error", $"å¿«é€Ÿæµ‹è¯•å‡ºé”™: {ex.Message}");
            overallStatus = "æµ‹è¯•å¤±è´¥";
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }
    
    private async Task TestWebSocketOnly()
    {
        if (isRunning) return;
        
        try
        {
            isRunning = true;
            testProgress = 0;
            overallStatus = "WebSocketæµ‹è¯•ä¸­...";
            
            AddLog("Info", "=== å¼€å§‹WebSocketä¸“é¡¹æµ‹è¯• ===");
            
            await TestWebSocketConnections();
            testProgress = 100;
            StateHasChanged();
            
            AddLog("Success", "=== WebSocketæµ‹è¯•å®Œæˆ ===");
            overallStatus = "WebSocketæµ‹è¯•å®Œæˆ";
        }
        catch (Exception ex)
        {
            AddLog("Error", $"WebSocketæµ‹è¯•å‡ºé”™: {ex.Message}");
            overallStatus = "æµ‹è¯•å¤±è´¥";
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }
    
    private async Task TestPermissions()
    {
        currentTest = "æ£€æŸ¥æƒé™...";
        AddLog("Info", "å¼€å§‹æƒé™æ£€æŸ¥");
        
        try
        {
            // æ£€æŸ¥ç½‘ç»œæƒé™
            var networkPermission = await Permissions.CheckStatusAsync<Permissions.NetworkState>();
            networkPermissionStatus = networkPermission.ToString();
            AddLog("Info", $"ç½‘ç»œæƒé™: {networkPermissionStatus}");
            
            // åœ¨Androidä¸Šï¼Œç½‘ç»œæƒé™é€šå¸¸æ˜¯è‡ªåŠ¨æˆäºˆçš„ï¼Œä¸éœ€è¦ç”¨æˆ·æˆæƒ
            if (networkPermission != PermissionStatus.Granted)
            {
                AddLog("Warning", "ç½‘ç»œæƒé™æœªæˆäºˆï¼Œå°è¯•è¯·æ±‚æƒé™");
                var requestResult = await Permissions.RequestAsync<Permissions.NetworkState>();
                networkPermissionStatus = requestResult.ToString();
            }
            
            wifiPermissionStatus = "è‡ªåŠ¨æˆäºˆ"; // WiFiçŠ¶æ€æƒé™æ˜¯è‡ªåŠ¨çš„
            networkStatePermissionStatus = "è‡ªåŠ¨æˆäºˆ"; // ç½‘ç»œçŠ¶æ€æƒé™æ˜¯è‡ªåŠ¨çš„
            
            permissionStatus = "æ£€æŸ¥å®Œæˆ";
            AddLog("Success", "æƒé™æ£€æŸ¥å®Œæˆ");
        }
        catch (Exception ex)
        {
            permissionStatus = "æ£€æŸ¥å¤±è´¥";
            AddLog("Error", $"æƒé™æ£€æŸ¥å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestNetworkConnectivity()
    {
        currentTest = "æ£€æŸ¥ç½‘ç»œè¿æ¥...";
        AddLog("Info", "å¼€å§‹ç½‘ç»œè¿æ¥æ£€æŸ¥");
        
        try
        {
            // æ£€æŸ¥ç½‘ç»œè®¿é—®
            var access = Connectivity.NetworkAccess;
            networkAccess = access.ToString();
            AddLog("Info", $"ç½‘ç»œè®¿é—®: {networkAccess}");
            
            // æ£€æŸ¥è¿æ¥é…ç½®
            var profiles = Connectivity.ConnectionProfiles;
            connectionProfiles = string.Join(", ", profiles);
            AddLog("Info", $"è¿æ¥é…ç½®: {connectionProfiles}");
            
            // æ£€æŸ¥ç½‘ç»œæ¥å£
            var interfaces = NetworkInterface.GetAllNetworkInterfaces();
            var activeInterfaces = interfaces.Where(i => i.OperationalStatus == OperationalStatus.Up).ToList();
            networkInterfaces = $"{activeInterfaces.Count} ä¸ªæ´»åŠ¨æ¥å£";
            AddLog("Info", $"ç½‘ç»œæ¥å£: {networkInterfaces}");
            
            foreach (var intf in activeInterfaces.Take(3))
            {
                AddLog("Debug", $"æ¥å£: {intf.Name} - {intf.NetworkInterfaceType} - {intf.OperationalStatus}");
            }
            
            connectivityStatus = "æ£€æŸ¥å®Œæˆ";
            AddLog("Success", "ç½‘ç»œè¿æ¥æ£€æŸ¥å®Œæˆ");
        }
        catch (Exception ex)
        {
            connectivityStatus = "æ£€æŸ¥å¤±è´¥";
            AddLog("Error", $"ç½‘ç»œè¿æ¥æ£€æŸ¥å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestDNSResolution()
    {
        currentTest = "æµ‹è¯•DNSè§£æ...";
        AddLog("Info", "å¼€å§‹DNSè§£ææµ‹è¯•");
        
        try
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();
            
            // æµ‹è¯•APIæœåŠ¡å™¨DNSè§£æ
            try
            {
                var apiHost = "api.tenclass.net";
                var apiAddresses = await System.Net.Dns.GetHostAddressesAsync(apiHost);
                dnsTestResult = $"æˆåŠŸ ({apiAddresses.Length} ä¸ªåœ°å€)";
                AddLog("Success", $"APIæœåŠ¡å™¨DNSè§£ææˆåŠŸ: {string.Join(", ", apiAddresses.Take(2))}");
            }
            catch (Exception ex)
            {
                dnsTestResult = "å¤±è´¥";
                AddLog("Error", $"APIæœåŠ¡å™¨DNSè§£æå¤±è´¥: {ex.Message}");
            }
            
            // æµ‹è¯•Google DNSè§£æ
            try
            {
                var googleAddresses = await System.Net.Dns.GetHostAddressesAsync("google.com");
                dnsGoogleResult = $"æˆåŠŸ ({googleAddresses.Length} ä¸ªåœ°å€)";
                AddLog("Success", $"Google DNSè§£ææˆåŠŸ: {string.Join(", ", googleAddresses.Take(2))}");
            }
            catch (Exception ex)
            {
                dnsGoogleResult = "å¤±è´¥";
                AddLog("Error", $"Google DNSè§£æå¤±è´¥: {ex.Message}");
            }
            
            stopwatch.Stop();
            dnsResolveTime = $"{stopwatch.ElapsedMilliseconds}ms";
            dnsStatus = "æµ‹è¯•å®Œæˆ";
            AddLog("Success", $"DNSè§£ææµ‹è¯•å®Œæˆï¼Œè€—æ—¶: {dnsResolveTime}");
        }
        catch (Exception ex)
        {
            dnsStatus = "æµ‹è¯•å¤±è´¥";
            AddLog("Error", $"DNSè§£ææµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestHttpConnections()
    {
        currentTest = "æµ‹è¯•HTTPè¿æ¥...";
        AddLog("Info", "å¼€å§‹HTTPè¿æ¥æµ‹è¯•");
        
        try
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();
            
            // æµ‹è¯•Google HTTPSè¿æ¥
            try
            {
                var googleResponse = await httpClient.GetAsync("https://www.google.com", new CancellationTokenSource(10000).Token);
                httpGoogleResult = $"æˆåŠŸ ({googleResponse.StatusCode})";
                AddLog("Success", $"Google HTTPSè¿æ¥æˆåŠŸ: {googleResponse.StatusCode}");
            }
            catch (Exception ex)
            {
                httpGoogleResult = "å¤±è´¥";
                AddLog("Error", $"Google HTTPSè¿æ¥å¤±è´¥: {ex.Message}");
            }
            
            // æµ‹è¯•APIæœåŠ¡å™¨HTTPSè¿æ¥
            try
            {
                var apiUrl = "https://api.tenclass.net/";
                var apiResponse = await httpClient.GetAsync(apiUrl, new CancellationTokenSource(10000).Token);
                httpApiResult = $"æˆåŠŸ ({apiResponse.StatusCode})";
                AddLog("Success", $"APIæœåŠ¡å™¨HTTPSè¿æ¥æˆåŠŸ: {apiResponse.StatusCode}");
            }
            catch (Exception ex)
            {
                httpApiResult = "å¤±è´¥";
                AddLog("Error", $"APIæœåŠ¡å™¨HTTPSè¿æ¥å¤±è´¥: {ex.Message}");
            }
            
            stopwatch.Stop();
            httpResponseTime = $"{stopwatch.ElapsedMilliseconds}ms";
            httpStatus = "æµ‹è¯•å®Œæˆ";
            AddLog("Success", $"HTTPè¿æ¥æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: {httpResponseTime}");
        }
        catch (Exception ex)
        {
            httpStatus = "æµ‹è¯•å¤±è´¥";
            AddLog("Error", $"HTTPè¿æ¥æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestWebSocketConnections()
    {
        currentTest = "æµ‹è¯•WebSocketè¿æ¥...";
        AddLog("Info", "å¼€å§‹WebSocketè¿æ¥æµ‹è¯•");
        
        try
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();
            
            // æµ‹è¯•WebSocket EchoæœåŠ¡å™¨
            await TestWebSocketEcho();
            
            // æµ‹è¯•API WebSocketè¿æ¥
            await TestWebSocketAPI();
            
            stopwatch.Stop();
            webSocketConnectTime = $"{stopwatch.ElapsedMilliseconds}ms";
            webSocketStatus = "æµ‹è¯•å®Œæˆ";
            AddLog("Success", $"WebSocketè¿æ¥æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: {webSocketConnectTime}");
        }
        catch (Exception ex)
        {
            webSocketStatus = "æµ‹è¯•å¤±è´¥";
            webSocketError = ex.Message;
            AddLog("Error", $"WebSocketè¿æ¥æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestWebSocketEcho()
    {
        try
        {
            using var webSocket = new ClientWebSocket();
            var cts = new CancellationTokenSource(10000); // 10ç§’è¶…æ—¶
            
            AddLog("Info", "è¿æ¥WebSocket EchoæœåŠ¡å™¨...");
            await webSocket.ConnectAsync(new Uri("wss://echo.websocket.org/"), cts.Token);
            
            if (webSocket.State == WebSocketState.Open)
            {
                webSocketEchoResult = "æˆåŠŸ";
                AddLog("Success", "WebSocket Echoè¿æ¥æˆåŠŸ");
                
                // å‘é€æµ‹è¯•æ¶ˆæ¯
                var testMessage = "Hello Echo Test";
                var buffer = System.Text.Encoding.UTF8.GetBytes(testMessage);
                await webSocket.SendAsync(new ArraySegment<byte>(buffer), WebSocketMessageType.Text, true, cts.Token);
                AddLog("Info", "å‘é€Echoæµ‹è¯•æ¶ˆæ¯");
                
                // æ¥æ”¶å›æ˜¾
                var receiveBuffer = new byte[1024];
                var result = await webSocket.ReceiveAsync(new ArraySegment<byte>(receiveBuffer), cts.Token);
                var receivedMessage = System.Text.Encoding.UTF8.GetString(receiveBuffer, 0, result.Count);
                AddLog("Success", $"æ”¶åˆ°Echoå›æ˜¾: {receivedMessage}");
                
                await webSocket.CloseAsync(WebSocketCloseStatus.NormalClosure, "Test complete", CancellationToken.None);
            }
            else
            {
                webSocketEchoResult = "è¿æ¥å¤±è´¥";
                AddLog("Error", $"WebSocket Echoè¿æ¥çŠ¶æ€å¼‚å¸¸: {webSocket.State}");
            }
        }
        catch (Exception ex)
        {
            webSocketEchoResult = "å¤±è´¥";
            AddLog("Error", $"WebSocket Echoæµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestWebSocketAPI()
    {
        try
        {
            using var webSocket = new ClientWebSocket();
            var cts = new CancellationTokenSource(10000); // 10ç§’è¶…æ—¶
            
            // è®¾ç½®è¯·æ±‚å¤´
            var token = "test-token";
            var deviceId = XiaoZhiSharp.Utils.SystemInfo.GetMacAddress();
            
            webSocket.Options.SetRequestHeader("Authorization", $"Bearer {token}");
            webSocket.Options.SetRequestHeader("Protocol-Version", "1");
            webSocket.Options.SetRequestHeader("Device-Id", deviceId);
            webSocket.Options.SetRequestHeader("Client-Id", Guid.NewGuid().ToString());
            
            AddLog("Info", "è¿æ¥API WebSocketæœåŠ¡å™¨...");
            AddLog("Info", $"URL: wss://api.tenclass.net/xiaozhi/v1/");
            AddLog("Info", $"Token: {token}");
            AddLog("Info", $"Device-Id: {deviceId}");
            
            await webSocket.ConnectAsync(new Uri("wss://api.tenclass.net/xiaozhi/v1/"), cts.Token);
            
            if (webSocket.State == WebSocketState.Open)
            {
                webSocketApiResult = "æˆåŠŸ";
                AddLog("Success", "API WebSocketè¿æ¥æˆåŠŸï¼");
                
                await webSocket.CloseAsync(WebSocketCloseStatus.NormalClosure, "Test complete", CancellationToken.None);
            }
            else
            {
                webSocketApiResult = "è¿æ¥å¤±è´¥";
                AddLog("Error", $"API WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸: {webSocket.State}");
            }
        }
        catch (Exception ex)
        {
            webSocketApiResult = "å¤±è´¥";
            webSocketError = ex.Message;
            AddLog("Error", $"API WebSocketæµ‹è¯•å¤±è´¥: {ex.Message}");
            
            // è¯¦ç»†åˆ†æé”™è¯¯
            if (ex.Message.Contains("401"))
            {
                AddLog("Warning", "å¯èƒ½çš„åŸå› : Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
            }
            else if (ex.Message.Contains("403"))
            {
                AddLog("Warning", "å¯èƒ½çš„åŸå› : è®¾å¤‡æœªæˆæƒæˆ–æƒé™ä¸è¶³");
            }
            else if (ex.Message.Contains("timeout"))
            {
                AddLog("Warning", "å¯èƒ½çš„åŸå› : ç½‘ç»œè¿æ¥è¶…æ—¶");
            }
            else if (ex.Message.Contains("SSL") || ex.Message.Contains("TLS"))
            {
                AddLog("Warning", "å¯èƒ½çš„åŸå› : SSL/TLSè¯ä¹¦éªŒè¯å¤±è´¥");
            }
        }
    }
    
    private void AnalyzeResults()
    {
        var issues = new List<string>();
        var successes = new List<string>();
        
        // åˆ†æå„é¡¹æµ‹è¯•ç»“æœ
        if (networkAccess != "Internet")
        {
            issues.Add("ç½‘ç»œè®¿é—®å—é™");
        }
        else
        {
            successes.Add("ç½‘ç»œè®¿é—®æ­£å¸¸");
        }
        
        if (dnsTestResult.Contains("å¤±è´¥"))
        {
            issues.Add("DNSè§£æå¤±è´¥");
        }
        else if (dnsTestResult.Contains("æˆåŠŸ"))
        {
            successes.Add("DNSè§£ææ­£å¸¸");
        }
        
        if (httpApiResult.Contains("å¤±è´¥"))
        {
            issues.Add("HTTPSè¿æ¥å¤±è´¥");
        }
        else if (httpApiResult.Contains("æˆåŠŸ"))
        {
            successes.Add("HTTPSè¿æ¥æ­£å¸¸");
        }
        
        if (webSocketEchoResult.Contains("å¤±è´¥"))
        {
            issues.Add("WebSocketåŸºç¡€è¿æ¥å¤±è´¥");
        }
        else if (webSocketEchoResult.Contains("æˆåŠŸ"))
        {
            successes.Add("WebSocketåŸºç¡€è¿æ¥æ­£å¸¸");
        }
        
        if (webSocketApiResult.Contains("å¤±è´¥"))
        {
            issues.Add("API WebSocketè¿æ¥å¤±è´¥");
        }
        else if (webSocketApiResult.Contains("æˆåŠŸ"))
        {
            successes.Add("API WebSocketè¿æ¥æ­£å¸¸");
        }
        
        // è¾“å‡ºåˆ†æç»“æœ
        AddLog("Info", "=== è¯Šæ–­ç»“æœåˆ†æ ===");
        
        if (successes.Any())
        {
            AddLog("Success", $"âœ… æ­£å¸¸é¡¹ç›®: {string.Join(", ", successes)}");
        }
        
        if (issues.Any())
        {
            AddLog("Error", $"âŒ é—®é¢˜é¡¹ç›®: {string.Join(", ", issues)}");
            overallStatus = "å‘ç°é—®é¢˜";
            
            // æä¾›è§£å†³å»ºè®®
            AddLog("Info", "=== è§£å†³å»ºè®® ===");
            
            if (issues.Contains("ç½‘ç»œè®¿é—®å—é™"))
            {
                AddLog("Warning", "å»ºè®®: æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿å·²è¿æ¥åˆ°äº’è”ç½‘");
            }
            
            if (issues.Contains("DNSè§£æå¤±è´¥"))
            {
                AddLog("Warning", "å»ºè®®: æ£€æŸ¥DNSè®¾ç½®ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–DNSæœåŠ¡å™¨");
            }
            
            if (issues.Contains("HTTPSè¿æ¥å¤±è´¥"))
            {
                AddLog("Warning", "å»ºè®®: æ£€æŸ¥ç½‘ç»œé˜²ç«å¢™è®¾ç½®å’ŒSSLè¯ä¹¦é…ç½®");
            }
            
            if (issues.Contains("WebSocketåŸºç¡€è¿æ¥å¤±è´¥"))
            {
                AddLog("Warning", "å»ºè®®: WebSocketåè®®å¯èƒ½è¢«ç½‘ç»œç¯å¢ƒé˜»æ­¢");
            }
            
            if (issues.Contains("API WebSocketè¿æ¥å¤±è´¥"))
            {
                AddLog("Warning", "å»ºè®®: æ£€æŸ¥API Tokenå’Œè®¾å¤‡æˆæƒçŠ¶æ€");
            }
        }
        else
        {
            overallStatus = "æ‰€æœ‰æµ‹è¯•é€šè¿‡";
            AddLog("Success", "ğŸ‰ æ‰€æœ‰ç½‘ç»œæµ‹è¯•éƒ½é€šè¿‡äº†ï¼");
        }
    }
    
    private void ClearResults()
    {
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        permissionStatus = networkPermissionStatus = wifiPermissionStatus = networkStatePermissionStatus = "æœªæµ‹è¯•";
        connectivityStatus = networkAccess = connectionProfiles = networkInterfaces = "æœªæµ‹è¯•";
        dnsStatus = dnsTestResult = dnsGoogleResult = dnsResolveTime = "æœªæµ‹è¯•";
        httpStatus = httpGoogleResult = httpApiResult = httpResponseTime = "æœªæµ‹è¯•";
        webSocketStatus = webSocketEchoResult = webSocketApiResult = webSocketConnectTime = "æœªæµ‹è¯•";
        webSocketError = "";
        
        diagnosticLogs.Clear();
        AddLog("Info", "è¯Šæ–­ç»“æœå·²æ¸…ç©º");
    }
    
    // UIè¾…åŠ©æ–¹æ³•
    private string GetTestIcon(string status)
    {
        return status switch
        {
            "æ£€æŸ¥å®Œæˆ" or "æµ‹è¯•å®Œæˆ" => "âœ…",
            "æ£€æŸ¥å¤±è´¥" or "æµ‹è¯•å¤±è´¥" => "âŒ",
            "æœªæµ‹è¯•" => "â³",
            _ => "ğŸ”„"
        };
    }
    
    private string GetStatusClass(string status)
    {
        if (status.Contains("æˆåŠŸ") || status.Contains("å®Œæˆ") || status == "Internet" || status == "Granted")
            return "text-success";
        if (status.Contains("å¤±è´¥") || status.Contains("é”™è¯¯"))
            return "text-danger";
        if (status.Contains("æœªæµ‹è¯•") || status.Contains("è­¦å‘Š"))
            return "text-warning";
        return "text-muted";
    }
    
    private string GetProgressClass()
    {
        if (testProgress >= 100) return "bg-success";
        if (testProgress >= 80) return "bg-info";
        if (testProgress >= 40) return "bg-warning";
        return "bg-primary";
    }
    
    private string GetOverallStatusClass()
    {
        if (overallStatus.Contains("é€šè¿‡") || overallStatus.Contains("å®Œæˆ"))
            return "text-success fw-bold";
        if (overallStatus.Contains("é—®é¢˜") || overallStatus.Contains("å¤±è´¥"))
            return "text-danger fw-bold";
        return "text-primary";
    }
    
    private string GetLogClass(string level)
    {
        return level switch
        {
            "Error" => "text-danger",
            "Success" => "text-success",
            "Warning" => "text-warning",
            "Debug" => "text-secondary",
            _ => "text-muted"
        };
    }
    
    private void AddLog(string level, string message)
    {
        diagnosticLogs.Add(new LogEntry
        {
            Timestamp = DateTime.Now,
            Level = level,
            Message = message
        });
        
        // ä¿æŒæ—¥å¿—æ•°é‡
        if (diagnosticLogs.Count > 200)
        {
            diagnosticLogs.RemoveAt(0);
        }
        
        // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
        Logger.LogInformation($"[{level}] {message}");
    }
    
    public void Dispose()
    {
        httpClient?.Dispose();
    }
    
    private class LogEntry
    {
        public DateTime Timestamp { get; set; }
        public string Level { get; set; } = "";
        public string Message { get; set; } = "";
    }
} 